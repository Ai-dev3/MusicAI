<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Similarity Tool</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header styling */
        .header {
            background-color: #C21807;
            color: white;
            padding: 20px;
            text-align: center;
        }

        /* Main content styling */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Button styling */
        .button {
            background-color: #C21807;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }

        .button:hover {
            background-color: #800000;
        }

        /* Hidden file input styling */
        .file-input {
            display: none;
        }

        /* Label styling to act as buttons */
        .file-label {
            display: inline-block;
            background-color: #C21807;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }

        .file-label:hover {
            background-color: #800000;
        }

        /* Footer styling */
        .footer {
            background-color: #C21807;
            color: white;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Header section -->
    <div class="header">
        <h1>Audio Similarity Tool</h1>
    </div>

    <!-- Main content section -->
    <div class="content">
        <h2>Upload Two Audios to Compare</h2>
        <form id="uploadForm" style="display: flex; flex-direction: column; align-items: center;">
            <!-- File inputs -->
            <input type="file" id="file1" class="file-input" required>
            <label for="file1" class="file-label">Upload Audio 1</label>
            <input type="file" id="file2" class="file-input" required>
            <label for="file2" class="file-label">Upload Audio 2</label>
            <!-- Submit button -->
            <button type="submit" class="button">Upload & Compare</button>
        </form>
        <div id="result"></div>
    </div>

    <!-- Footer section -->
    <div class="footer">
        <button class="button" onclick="window.location.href='index.html';">Main Page</button>
        <button class="button" onclick="window.location.href='pastrecordings.html';">View Past Recordings</button> 
    </div>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

    <!-- JavaScript to handle audio upload and comparison -->
    <script>
        document.getElementById('uploadForm').onsubmit = async function(event) {
            event.preventDefault();

            const file1 = document.getElementById('file1').files[0];
            const file2 = document.getElementById('file2').files[0];

            if (!file1 || !file2) {
                document.getElementById('result').innerText = 'Please upload both files.';
                console.log('Error: One or both files are missing.');
                return;
            }

            // Show status message in the browser
            document.getElementById('result').innerText = 'Processing...';

            try {
                // Convert the audio files to tensors
                console.log('Converting file 1 to tensor...');
                const tensor1 = await audioFileToTensor(file1);
                console.log('File 1 converted successfully:', tensor1);

                console.log('Converting file 2 to tensor...');
                const tensor2 = await audioFileToTensor(file2);
                console.log('File 2 converted successfully:', tensor2);

                // Trim the longer tensor to match the shorter tensor
                const trimmedTensors = trimTensorsToSameLength(tensor1, tensor2);
                const trimmedTensor1 = trimmedTensors[0];
                const trimmedTensor2 = trimmedTensors[1];

                // Calculate similarity between the trimmed tensors
                console.log('Calculating similarity...');
                const similarity = calculateCosineSimilarity(trimmedTensor1, trimmedTensor2);
                console.log('Similarity calculated:', similarity);

                // Display the similarity result
                document.getElementById('result').innerText = 'Similarity Score: ' + similarity.toFixed(2);
            } catch (error) {
                console.error('An error occurred during processing:', error);
                document.getElementById('result').innerText = 'An error occurred during processing. See console for details.';
            }
        }

        // Function to process the audio file into a tensor
        async function audioFileToTensor(file) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const fileData = await file.arrayBuffer();
                console.log('File data loaded successfully.');
                const audioBuffer = await audioContext.decodeAudioData(fileData);
                console.log('Audio buffer decoded successfully.');

                // Take only the first channel for simplicity
                const channelData = audioBuffer.getChannelData(0);
                console.log('Channel data extracted:', channelData);

                // Convert the audio data to a TensorFlow.js tensor
                return tf.tensor(channelData);
            } catch (error) {
                console.error('Error processing audio file:', error);
                throw error;
            }
        }

        // Function to calculate cosine similarity between two tensors
        function calculateCosineSimilarity(tensor1, tensor2) {
            try {
                // Calculate the dot product
                const dotProduct = tf.sum(tf.mul(tensor1, tensor2)).arraySync();
                // Calculate magnitudes (Euclidean norm)
                const magnitude1 = tf.sqrt(tf.sum(tf.square(tensor1))).arraySync();
                const magnitude2 = tf.sqrt(tf.sum(tf.square(tensor2))).arraySync();

                // Return the cosine similarity
                return dotProduct / (magnitude1 * magnitude2);
            } catch (error) {
                console.error('Error calculating similarity:', error);
                throw error;
            }
        }

        // Function to trim tensors to the same length
        function trimTensorsToSameLength(tensor1, tensor2) {
            const length1 = tensor1.shape[0];
            const length2 = tensor2.shape[0];

            const minLength = Math.min(length1, length2);

            // Slice tensors to the same length
            const trimmedTensor1 = tensor1.slice([0], [minLength]);
            const trimmedTensor2 = tensor2.slice([0], [minLength]);

            return [trimmedTensor1, trimmedTensor2];
        }
    </script>




</body>
</html>
